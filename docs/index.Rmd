---
title: "NF Vocabulary / Schema"
author: "NF-OSI DCC"
date: "11/14/2021"
output: 
  html_document:
    theme: lumen
    css: custom.css
    toc: true
    toc_float: 
      collapsed: false
    toc_depth: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(reactable)
library(htmltools)

source("graph.R")

basicTable <- function(dt, columns = c("Attribute", "Description")) {
  reactable(dt[, columns], 
          filterable = TRUE,
          pagination = FALSE,
          columns = list(
            Attribute = colDef(name = "Label", maxWidth = 250)
          ),
          wrap = FALSE,
          class = "term-table"
  )
}

expandedTable <- function(dt) {
  row_details <- function(index) {
    expanded <- dt[index, ]
    detail <- div(
      class = "detail",
      div(class = "detail-header",  expanded$Attribute, 
          span(class = "detail-title",  expanded$Description))
    )
    detail
  }

  reactable(dt[, c("Attribute", "Description")], 
          filterable = TRUE,
          pagination = FALSE,
          onClick = "expand",
          columns = list(
            Attribute = colDef(name = "Label", maxWidth = 250)
            # DependsOn = colDef(name = "Fields")
          ),
          details = row_details,
          wrap = FALSE,
          class = "term-table"
  )
}

SCHEMA_CSV <- "../NF.csv"
EXT_CLASSES_CSV <- "../ext_classes.csv"
EXT_RELATIONS_CSV <- "../ext_relations.csv"
```

```{r process_schema_table, echo=FALSE}

# To avoid overwhelming info and keep page neat, read in schema and
# process only selected columns
# Aside from default schematic columns, 
# we require internal columns prefixed with `.` to have a useful table
schema <- read.csv(SCHEMA_CSV) %>%
  select(Attribute, Description, Valid.Values, DependsOn, Parent, 
         Type = .Type, Root = .Root, SubclassOf = .SubclassOf)

# Splits terms into Property or Class using `Type`
# schema_class <- schema %>%
#   filter(Type == "Class")

# Not displayed yet
# schema_prop <- schema %>%
#  filter(Type == "Property")

```

## Annotation Classes

:::info

These are standard terms available to NF resource contributors for annotation of their resource.
When contributors use these terms, they are helping to label and classify their resource for improved interoperability and findability.

:::

### Assay Module

#### Assays {.tabset .tabset-fade .tabset-pills}

##### Terms

```{r assays_table, echo=FALSE}

assays_table <- schema %>%
  filter(Root == "Assay") %>%
  select(Attribute, Description, DependsOn)

expandedTable(assays_table)

```


##### Relations Graph

:::info

This partial graph view logically relates **assays** to metadata **templates** available at the [NF Data Curator App](https://shiny.synapse.org/users/rallaway/NF_data_curator/).
For example, assays under the classification of `Imaging_Assay` currently uses a generic `Imaging_Assay_Template` for annotation.
More specialized templates may be made available as needed for specific assays.

:::

```{r schema_ext_assay_template, out.width="100%", echo=FALSE}

schema_ext <- readExtSchema(SCHEMA_CSV, EXT_CLASSES_CSV)
assay <- getNodesEdges(schema_ext, "Assay", "A", 
                       nodes = list(color = list(A = "plum", C = "indigo"), 
                                    font.color = list(A = "black", C = "white")))
template <- getNodesEdges(schema_ext, "Template", "T", use_id = T, 
                          nodes = list(color = list(A = "pink", C = "firebrick"), 
                                       font.color = list(A = "black", C = "white")))
g_assay_template <- c2Cluster(assay, template, "suggests", EXT_RELATIONS_CSV)
defaultGraph(g_assay_template)

```

#### Platforms {.tabset .tabset-fade .tabset-pills}

##### Terms

```{r platforms_table, echo=FALSE}

platforms_table <- schema %>%
  filter(Parent == "platform") %>%
  select(Attribute, Description, DependsOn)

basicTable(platforms_table)
```


##### Relations Graph

:::info

This partial graph view logically relates **assays** to common **platforms**.

:::

*Documentation currently in development.*

### Data Module

#### Data Types {.tabset .tabset-fade .tabset-pills}

##### Terms

```{r data_types_table, echo=FALSE}

data_types_table <- schema %>%
  filter(Parent == "dataType") %>%
  select(Attribute, Description, DependsOn)

basicTable(data_types_table)
```

##### Relations Graph

:::info

This partial graph view logically relates **data types** to **assays**.

:::

*Documentation currently in development.*

#### Data Formats {.tabset .tabset-fade .tabset-pills}

##### Terms

:::info

Certain terms are emphasized as <div class='warning badge' display=inline>proprietary</div>, which make data less interoperable/reusable, as opposed to our <div class='good badge' display=inline>preferred</div> (open) formats.

:::

```{r data_formats_table, echo=FALSE}

data_formats_table <- schema %>%
  filter(Parent == "fileFormat") %>%
  select(Attribute, Description, Note = SubclassOf)
  
# A little more complicated than the other tables
reactable(data_formats_table, 
          filterable = TRUE,
          pagination = FALSE,
          columns = list(
            Attribute = colDef(name = "Label", maxWidth = 150),
            Note = colDef(
              maxWidth = 100,
              cell = function(value) {
                label <- switch(value, Preferred_Open_Format = "preferred", Proprietary_Format = "proprietary", "")
                class <- switch(value, Preferred_Open_Format = "good", Proprietary_Format = "warning", "")
                div(class = paste(class, "badge"), label)
              }
            )
          ),
          wrap = FALSE,
          class = "term-table"
  )

```

##### Relations Graph

:::info

This partial graph view logically organizes **data formats** and notes which formats are interconvertible.

:::

*Documentation currently in development.*

### Biospecimen Module

#### Species {.tabset .tabset-fade .tabset-pills}

##### Terms
```{r species_table, echo=FALSE}

species_table <- schema %>%
  filter(Parent == "species") %>%
  select(Attribute, Description, DependsOn)

basicTable(species_table)
```

#### Specimen Type {.tabset .tabset-fade .tabset-pills}

*Documentation currently in development.*

##### Terms

##### Relations Graph

#### Genotypes {.tabset .tabset-fade .tabset-pills}

##### Terms
```{r genotypes_table, echo=FALSE}

genotypes_table <- schema %>%
  filter(Root == "Genotype") %>%
  select(Attribute, Description, DependsOn)

basicTable(genotypes_table)
```

#### Tumor Phenotypes {.tabset .tabset-fade .tabset-pills}

##### Terms
```{r tumor_diagnosis_table, echo=FALSE}

tumor_diagnosis_table <- schema %>%
  filter(Parent == "tumorType") %>%
  select(Attribute, Description, DependsOn)

basicTable(tumor_diagnosis_table)
```

## Annotation Templates & Properties 

#### Standard {.tabset .tabset-fade .tabset-pills}

:::info

A resource can have many annotation properties used to describe it. 
For example, if a resource as an "assay" annotation property, contributors can give it an assay annotation.
This is represented by the spreadsheet templates available for use; each of the columns allow contributors to say something distinct about their (data) entity. 
Templates effectively define a profile over a collection of properties.
Most annotation properties are "user" annotation properties -- intended for use by the resource contributors on the NF platform.
For additional context, see also [System Annotation Properties](#reserved).

:::

##### Genomics Assay Template


*Documentation currently in development.*

```{r standard_properties_table, echo=FALSE, eval=FALSE}

# Custom code to get unique set of properties used across all templates
standard_properties_table <- schema %>%
  filter(Parent %in% c("template")) %>%
  select(Attribute, Description, DependsOn)

basicTable(standard_properties_table)
```


#### System {#reserved .tabset .tabset-fade .tabset-pills}

:::info

System annotation properties also describe the resource in some way, but they are not expected to be edited directly by contributors. 
They are computed/automated annotations set by the data platform and DCC activities.

:::

##### Terms
```{r reserved_properties_table, echo=FALSE}

reserved__properties_table <- schema %>%
  filter(Root %in% c("dccProperty", "synapseProperty")) %>%
  select(Attribute, Description, DependsOn)

basicTable(reserved__properties_table)
```


