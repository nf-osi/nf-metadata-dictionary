name: "Test Synonym Injection (Branch-based)"

# Only allow manual dispatch:
on:
  workflow_dispatch:
    inputs:
      target-branch:
        description: 'Branch to run injection workflow on'
        required: true
        default: 'github-action-synoynms'
      csv_file:
        description: 'Path to synonym CSV file'
        required: false
        type: string
        default: 'term_synonyms.csv'
      test_mode:
        description: 'Run in test mode (dry-run)'
        required: false
        type: boolean
        default: true

jobs:
  inject-synonyms:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Short timeout for injection only
    permissions:
      contents: write  # Allow the workflow to push changes back to the repository
      pull-requests: write  # Allow creating pull requests
    steps:
      - name: Checkout code from chosen branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target-branch }}

      - name: Print branch info
        run: |
          echo "Running injection workflow on branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Latest commit:"
          git log -1 --pretty=oneline
          echo ""
          echo "Workflow parameters:"
          echo "- CSV file: ${{ github.event.inputs.csv_file }}"
          echo "- Test mode: ${{ github.event.inputs.test_mode }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Verify CSV file exists
        run: |
          CSV_FILE="${{ github.event.inputs.csv_file }}"
          if [ ! -f "$CSV_FILE" ]; then
            echo "Error: CSV file '$CSV_FILE' not found"
            echo "Available files:"
            ls -la *.csv || echo "No CSV files found"
            exit 1
          fi
          
          echo "Found CSV file: $CSV_FILE"
          echo "CSV file size: $(wc -l < "$CSV_FILE") lines"
          echo "First 5 lines:"
          head -5 "$CSV_FILE"

      - name: Test injection workflow script exists
        run: |
          if [ ! -f "utils/inject_synonyms.py" ]; then
            echo "Error: injection script not found on this branch"
            echo "Available files in utils/:"
            ls -la utils/ || echo "utils/ directory not found"
            exit 1
          fi
          echo "✅ Injection script found: utils/inject_synonyms.py"

      - name: Inject synonyms (dry-run)
        if: github.event.inputs.test_mode == 'true'
        run: |
          CSV_FILE="${{ github.event.inputs.csv_file }}"
          echo "🧪 Running in test mode - dry run only"
          python utils/inject_synonyms.py --csv "$CSV_FILE" --modules-dir modules --dry-run

      - name: Inject synonyms (production)
        if: github.event.inputs.test_mode != 'true'
        run: |
          CSV_FILE="${{ github.event.inputs.csv_file }}"
          echo "🚀 Running in production mode - will modify files"
          python utils/inject_synonyms.py --csv "$CSV_FILE" --modules-dir modules

      - name: Check if changes were made
        id: check_changes
        if: github.event.inputs.test_mode != 'true'
        run: |
          # Check if any module files were modified
          if git diff --exit-code modules/ 2>/dev/null; then
            echo "No changes made to module files"
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "changes_made=false" >> $GITHUB_ENV
          else
            echo "Changes detected in module files"
            git diff --stat modules/ || true
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "changes_made=true" >> $GITHUB_ENV
            
            # Show a summary of changes
            echo "Modified files:"
            git diff --name-only modules/
            echo ""
            echo "Change summary:"
            git diff --stat modules/
          fi

      - name: Create Pull Request with synonym injection
        if: steps.check_changes.outputs.changes_made == 'true' && github.event.inputs.test_mode != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Inject synonyms into module files (from ${{ github.event.inputs.target-branch }})
            
            - Applied synonyms from ${{ github.event.inputs.csv_file }}
            - Updated module YAML files with new aliases
            - Applied intelligent filtering to avoid duplicates
            - Source branch: ${{ github.event.inputs.target-branch }}
          title: "Inject synonyms: Update module files with synonym aliases (from ${{ github.event.inputs.target-branch }})"
          body: |
            ## 🔄 Synonym Injection Update (Branch Test)
            
            This PR contains synonym aliases injected into module YAML files using the injection workflow from branch `${{ github.event.inputs.target-branch }}`:
            
            ### Changes Made
            - **📁 Module Files**: Injected aliases into module YAML files in `modules/` directory
            - **📊 Source Data**: Used synonyms from `${{ github.event.inputs.csv_file }}`
            - **🧹 Quality Filtering**: Applied intelligent deduplication and filtering
            - **🌿 Source Branch**: `${{ github.event.inputs.target-branch }}`
            
            ### Review Checklist
            - [ ] Review alias additions in modified module files
            - [ ] Verify no unwanted synonyms were added
            - [ ] Confirm aliases enhance searchability without adding noise
            - [ ] Check that existing aliases weren't removed unexpectedly
            - [ ] Validate that changes are appropriate for merging to main
            
            ### Technical Details
            - Case-only differences filtered out (e.g., "3D imaging" vs "3-D Imaging")
            - Fuzzy matching applied to remove near-duplicates (90% similarity threshold)
            - Only high-quality aliases added to preserve metadata integrity
            - Existing aliases preserved unless they conflict
            
            ### Files Modified
            ```
            $(git diff --stat modules/ 2>/dev/null || echo "No changes detected")
            ```
            
            **Workflow Run**: ${{ github.run_id }}
            **Source Branch**: ${{ github.event.inputs.target-branch }}
            **CSV Source**: ${{ github.event.inputs.csv_file }}
            **Test Mode**: ${{ github.event.inputs.test_mode }}
          branch: synonym-injection-test-${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            synonyms
            injection
            branch-test

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Synonym Injection Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CSV_FILE="${{ github.event.inputs.csv_file }}"
          
          echo "**Branch**: \`${{ github.event.inputs.target-branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**CSV File**: \`$CSV_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Test Mode**: \`${{ github.event.inputs.test_mode }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            echo "🧪 **Test Mode**: Dry-run completed" >> $GITHUB_STEP_SUMMARY
            echo "- 📊 CSV file: $CSV_FILE verified" >> $GITHUB_STEP_SUMMARY
            echo "- 📁 Module injection: Simulated only" >> $GITHUB_STEP_SUMMARY
            echo "- 🔄 No actual changes made" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_changes.outputs.changes_made }}" = "true" ]; then
            echo "✅ **Success**: Synonyms injected and PR created for review" >> $GITHUB_STEP_SUMMARY
            echo "- 📊 CSV file: $CSV_FILE processed" >> $GITHUB_STEP_SUMMARY
            echo "- 📁 Module files: Updated with new aliases" >> $GITHUB_STEP_SUMMARY
            echo "- 🔄 Pull Request: Created for review (branch: synonym-injection-test-${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **No Changes**: No synonym injection needed" >> $GITHUB_STEP_SUMMARY
            echo "- 📊 CSV file: $CSV_FILE processed successfully" >> $GITHUB_STEP_SUMMARY
            echo "- 📁 Module files: No updates required (synonyms already present)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Source Branch: ${{ github.event.inputs.target-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- CSV Source: $CSV_FILE" >> $GITHUB_STEP_SUMMARY
