name: Update NF Tools Central Links

on:
  schedule:
    # Run every Monday at 10:00 AM UTC (1 hour after model system sync)
    - cron: '0 10 * * 1'
  workflow_dispatch:
    # Allow manual triggering

env:
  SYNAPSE_TABLE_ID: syn51730943

jobs:
  update-tool-links:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.NF_SERVICE_GIT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Get current date
        id: date
        run: |
          echo "date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "date-short=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install synapseclient pandas pyyaml

      - name: Add NF Tools Central links to schema
        run: |
          python scripts/add_tool_links.py
        env:
          # syn51730943 is open access - token is optional
          # If anonymous access fails, add SYNAPSE_AUTH_TOKEN to repository secrets
          SYNAPSE_AUTH_TOKEN: ${{ secrets.SYNAPSE_AUTH_TOKEN || '' }}

      - name: Check for changes
        id: changes
        run: |
          if [[ $(git status --porcelain modules/Sample/CellLineModel.yaml modules/Sample/AnimalModel.yaml modules/Experiment/Antibody.yaml modules/Experiment/GeneticReagent.yaml) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in schema files"
            echo "### Changed files:" >> $GITHUB_STEP_SUMMARY
            git status --porcelain modules/Sample/CellLineModel.yaml modules/Sample/AnimalModel.yaml modules/Experiment/Antibody.yaml modules/Experiment/GeneticReagent.yaml >> $GITHUB_STEP_SUMMARY
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
            echo "ℹ️ No changes needed - schema links are up to date." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Show diff summary
        if: steps.changes.outputs.changes == 'true'
        run: |
          echo "### Summary of changes:" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          git diff --stat modules/Sample/CellLineModel.yaml modules/Sample/AnimalModel.yaml modules/Experiment/Antibody.yaml modules/Experiment/GeneticReagent.yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Rebuild data model artifacts
        if: steps.changes.outputs.changes == 'true'
        run: |
          # Install required tools for building
          bash < <(curl -s https://raw.githubusercontent.com/babashka/babashka/master/install)
          git clone --depth 1 https://github.com/anngvu/retold.git
          pip install linkml==v1.8.1
          npm install -g json-dereference-cli

          # Rebuild the data model
          make NF.yaml
          bb ./retold/retold as-jsonld --dir modules --out NF.jsonld

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.NF_SERVICE_GIT_TOKEN }}
          commit-message: "chore: update NF Tools Central links from ${{ env.SYNAPSE_TABLE_ID }}"
          title: "Sync New Tools from NF Tools Central - ${{ steps.date.outputs.date }}"
          body: |
            This PR synchronizes schema enums with NF Tools Central, adding new tools/resources and updating links as needed.

            **Source:** Synapse table `${{ env.SYNAPSE_TABLE_ID }}`
            **Sync Date:** ${{ steps.date.outputs.date }}

            ### What This Does:

            Synchronizes schema enums with NF Tools Central (syn51730943):
            - **Adds NEW tools/resources** as new enum values with `see_also` links
            - **Updates existing** `see_also` links (if resourceId changed, though rare)

            This ensures the schema stays current as new tools are added to NF Tools Central.

            **Example:**
            ```yaml
            "JH-2-002":
              description: "Collected during surgical resection from patients with NF1-MPNST"
              see_also:
                - https://nf.synapse.org/Explore/Tools/DetailsPage/Details?resourceId=1bc84ef2-208f-4f0e-8045-6be47fd968de
            ```

            ### Changes Made:
            - Updated cell line links in `modules/Sample/CellLineModel.yaml`
            - Updated animal model links in `modules/Sample/AnimalModel.yaml`
            - Updated antibody links in `modules/Experiment/Antibody.yaml`
            - Updated genetic reagent links in `modules/Experiment/GeneticReagent.yaml`
            - Rebuilt data model artifacts (`NF.jsonld`, `dist/NF.yaml`)

            ### Files Modified:
            - `modules/Sample/CellLineModel.yaml`
            - `modules/Sample/AnimalModel.yaml`
            - `modules/Experiment/Antibody.yaml`
            - `modules/Experiment/GeneticReagent.yaml`
            - `NF.jsonld`
            - `dist/NF.yaml`
            - Potentially `registered-json-schemas/*.json` (if regenerated)

            ### Benefits:
            - ✅ New tools automatically available in schema dropdowns
            - ✅ Webdev team can access resource links directly from schema
            - ✅ No REST API call needed for tooltips
            - ✅ Schema stays synchronized with NF Tools Central
            - ✅ ResourceIds automatically updated if changed (rare)

            ### Related:
            - PR #780 (tooltip/reference service implementation)
            - Addresses feedback to store links in schema instead of REST API

            **Automated update via:** `.github/workflows/update-tool-links.yml`
          branch: update/tool-links-${{ steps.date.outputs.date-short }}
          labels: |
            automated
            tool-links
            schema-update
          draft: false

      - name: Comment on success
        if: steps.changes.outputs.changes == 'true'
        run: |
          echo "✅ Tool links update completed successfully. A pull request has been created with the updates." >> $GITHUB_STEP_SUMMARY

      - name: Comment on no changes
        if: steps.changes.outputs.changes == 'false'
        run: |
          echo "ℹ️ Tool links update completed. No changes were needed - the schema is up to date." >> $GITHUB_STEP_SUMMARY
