name: Weekly Model System Sync and Annotation Review

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      annotation_limit:
        description: 'Limit annotation records (for testing)'
        required: false
        type: string
        default: ''
      skip_model_sync:
        description: 'Skip model system sync (annotations only)'
        required: false
        type: boolean
        default: false
      skip_annotation_review:
        description: 'Skip annotation review (model sync only)'
        required: false
        type: boolean
        default: false

env:
  SYNAPSE_TABLE_ID: syn26450069
  SYNAPSE_TOOLS_TABLE_ID: syn51730943
  SYNAPSE_MATERIALIZED_VIEW: syn52702673

jobs:
  sync-model-systems:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Get current date
        id: date
        run: |
          echo "date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "date-short=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install synapseclient pyyaml pandas

      - name: Sync model system data
        if: github.event.inputs.skip_model_sync != 'true'
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.DATA_MODEL_SERVICE }}
        run: |
          python utils/sync_model_systems.py --synapse-id ${{ env.SYNAPSE_TABLE_ID }}

      # ============================================================
      # ANNOTATION REVIEW - Review Synapse file annotations
      # ============================================================

      - name: Review Synapse annotations
        if: github.event.inputs.skip_annotation_review != 'true'
        id: annotation_review
        env:
          SYNAPSE_AUTH_TOKEN: ${{ secrets.DATA_MODEL_SERVICE }}
        run: |
          echo "ðŸ” Reviewing Synapse annotations from view ${{ env.SYNAPSE_MATERIALIZED_VIEW }}..."

          # Build command
          CMD="python utils/review_annotations.py"

          # Add limit if specified (for manual testing)
          if [ -n "${{ github.event.inputs.annotation_limit }}" ]; then
            CMD="$CMD --limit ${{ github.event.inputs.annotation_limit }}"
            echo "ðŸ“Š Limiting to ${{ github.event.inputs.annotation_limit }} records for testing"
          fi

          echo "Running: $CMD"
          $CMD

          # Check if suggestions were generated
          if [ -f annotation_suggestions.json ]; then
            SUGGESTION_COUNT=$(python3 -c "import json; data = json.load(open('annotation_suggestions.json')); print(len(data.get('suggestions', {})))")
            echo "suggestion_count=$SUGGESTION_COUNT" >> $GITHUB_OUTPUT

            if [ "$SUGGESTION_COUNT" -gt 0 ]; then
              # Check if any YAML files were modified
              if git diff --quiet modules/; then
                echo "has_suggestions=false" >> $GITHUB_OUTPUT
                echo "â„¹ï¸  All suggested values already exist in schema"
              else
                echo "has_suggestions=true" >> $GITHUB_OUTPUT
                echo "âœ… Found $SUGGESTION_COUNT fields with annotation suggestions"
                echo "âœ… Modified YAML enum files with new values"

                # Show what was modified
                echo ""
                echo "ðŸ“ Modified files:"
                git diff --name-only modules/

                # Show preview
                if [ -f annotation_suggestions.md ]; then
                  echo ""
                  echo "ðŸ“ Summary:"
                  head -n 40 annotation_suggestions.md
                fi
              fi
            else
              echo "has_suggestions=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  No new annotation suggestions - all values match schema"
            fi
          else
            echo "has_suggestions=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No suggestion file generated"
          fi

      # ============================================================
      # CHECK FOR CHANGES AND REBUILD ARTIFACTS
      # ============================================================

      - name: Check for changes from both sources
        id: changes
        run: |
          if [[ $(git status --porcelain modules/) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in modules/ from model sync and/or annotation review"
            echo ""
            echo "Modified files:"
            git status --porcelain modules/
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Rebuild data model artifacts
        if: steps.changes.outputs.changes == 'true'
        run: |
          # Install required tools for building
          bash < <(curl -s https://raw.githubusercontent.com/babashka/babashka/master/install)
          git clone --depth 1 https://github.com/anngvu/retold.git
          pip install linkml==v1.8.1
          npm install -g json-dereference-cli

          # Rebuild the data model
          make NF.yaml
          bb ./retold/retold as-jsonld --dir modules --out NF.jsonld

      # ============================================================
      # CREATE COMBINED PULL REQUEST
      # ============================================================

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: weekly Synapse sync and annotation review"
          title: "Weekly Sync: Model Systems and Annotation Review - ${{ steps.date.outputs.date }}"
          body: |
            This PR contains the weekly sync of model systems and annotation review suggestions.

            **Sync Date:** ${{ steps.date.outputs.date }}

            ---

            ## Model System Sync

            ${{ github.event.inputs.skip_model_sync != 'true' && 'âœ… **Updated model systems and tools from Synapse tables**' || 'â­ï¸ Skipped' }}

            **Sources:**
            - Model systems: `${{ env.SYNAPSE_TABLE_ID }}`
            - Tool links: `${{ env.SYNAPSE_TOOLS_TABLE_ID }}`

            ---

            ## Annotation Review

            ${{ steps.annotation_review.outputs.has_suggestions == 'true' && format('âœ… **Found {0} fields with suggested additions**', steps.annotation_review.outputs.suggestion_count) || (github.event.inputs.skip_annotation_review != 'true' && 'âœ“ No new annotation suggestions - all values match schema' || 'â­ï¸ Skipped') }}

            **Source:** Synapse materialized view `${{ env.SYNAPSE_MATERIALIZED_VIEW }}`

            ${{ steps.annotation_review.outputs.has_suggestions == 'true' && '
            **Note:** New enum values have been automatically added based on annotation frequency (minimum 2 occurrences). Review the changes to ensure they are appropriate before merging.

            See `annotation_suggestions.json` and `annotation_suggestions.md` for details and frequency counts.' || '' }}

            ---

            ## Artifacts Rebuilt

            âœ… **Data model artifacts have been rebuilt** to reflect all changes from both sources:
            - `dist/NF.yaml` - Complete merged schema
            - `NF.jsonld` - JSON-LD representation

            ---

            **Automated via:** `.github/workflows/weekly-model-system-sync.yml`
          branch: sync/weekly-maintenance-${{ steps.date.outputs.date-short }}
          labels: |
            automated
            weekly-sync
          draft: false
      
      - name: Workflow summary
        if: always()
        run: |
          echo "### Weekly Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### Model System Sync" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.skip_model_sync }}" = "true" ]; then
            echo "â­ï¸ Skipped (manual override)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Ran model system sync from Synapse tables" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### Annotation Review" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.skip_annotation_review }}" = "true" ]; then
            echo "â­ï¸ Skipped (manual override)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.annotation_review.outputs.has_suggestions }}" = "true" ]; then
            echo "âœ… Found ${{ steps.annotation_review.outputs.suggestion_count }} fields with suggestions" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ“ No new annotation suggestions" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### Changes and Artifacts" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.changes }}" = "true" ]; then
            echo "âœ… Changes detected from sync operations" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Data model artifacts rebuilt" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **A pull request has been created with the updates**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ“ No changes needed - dictionary is up to date" >> $GITHUB_STEP_SUMMARY
          fi